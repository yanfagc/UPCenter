<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.hanzhdy.manager.upc.mapper.MenuMapperExt">
  <select id="countAsList" parameterType="java.util.HashMap" resultType="int">
  SELECT COUNT(1)AS mc FROM r_menu m <include refid="wherecause_menu"/>
  </select>
  
  <select id="selectAsList" parameterType="java.util.HashMap" resultType="org.hanzhdy.manager.upc.vo.MenuVo">
  <include refid="Pageable_Prefix" />
	  SELECT * FROM ((SELECT
	  m.ID AS id,
	  m.MENUCODE AS CODE,
	  m.MENUNAME AS NAME,
	  m.URLTYPE AS urltype,
	  m.MENUURL AS url,
	  m.STATUS AS status,
	  m.SORT AS sort,
	  m.SHOWFLAG AS showflag
	  FROM r_menu m
	  <include refid="wherecause_menu"/>)
	  UNION (SELECT
	  i.ID AS id,
	  i.ITEMCODE AS CODE,
	  i.ITEMNAME AS NAME,
	  'RES' AS urltype,
	  i.RESOURCE AS url,
	  i.STATUS AS status,
	  i.SORT AS sort,
	  'SHOW' AS showflag
	  FROM r_menuitem i
	  <include refid="wherecause_menuitem"/>)
	  ) m
	ORDER BY m.SORT ASC
    <include refid="Pageable_Suffix" />
  </select>
  
  <sql id="wherecause_menu">
  WHERE m.PARENTID = #{parentid}
    <if test="searchkey!=null and searchkey!=''">
    AND (MENUCODE LIKE #{searchkey} OR MENUNAME LIKE #{searchkey})
    </if>
    <if test="systemid!=null and systemid!=''">
    AND SYSTEMID=#{systemid}
    </if>
    <if test="urltype!=null and urltype!=''">
    AND URLTYPE=#{urltype}
    </if>
    <if test="status!=null and status!=''">
    AND STATUS=#{status}
    </if>
  </sql>

  <sql id="wherecause_menuitem">
    WHERE i.MENUID = #{parentid}
    <if test="searchkey!=null and searchkey!=''">
    AND (ITEMCODE LIKE #{searchkey} OR ITEMCODE LIKE #{searchkey})
    </if>
    <if test="status!=null and status!=''">
    AND STATUS=#{status}
    </if>
  </sql>
  
  <select id="selectAsZTreeNodeByRoleAndSystemid" parameterType="java.util.HashMap" resultType="org.hanzhdy.web.bean.ZTreeNode">
  SELECT
		concat('m_',m.ID) AS id,
		m.MENUNAME AS NAME,
	IF(m.PARENTID IS NULL OR m.PARENTID='0','0',concat('m_',m.PARENTID)) AS pId,
		'true' AS OPEN,
		'true' AS isParent,
		m.SORT AS sort,
	IF (
		rm.ROLEID IS NOT NULL
		AND rm.ROLEID <![CDATA[<>]]> '',
		'true',
		'false'
	) AS checked
	FROM
		r_menu m
	LEFT JOIN r_role_menu rm ON (
		m.ID = rm.MENUID
		AND rm.ROLEID = #{roleid}
	)
	WHERE
		m.SYSTEMID = #{systemid}
	AND m.`STATUS` <![CDATA[<>]]> 'D'
  ORDER BY m.SORT ASC
  
  </select>

  <select id="selectAsZTreeNodeByRoleAndSystemidForSettingItem" parameterType="java.util.HashMap" resultType="org.hanzhdy.web.bean.ZTreeNode">
  SELECT
		concat('m_',m.ID) AS id,
		m.MENUNAME AS NAME,
	IF(m.PARENTID IS NULL OR m.PARENTID='0','0',concat('m_',m.PARENTID)) AS pId,
		'true' AS OPEN,
		'true' AS isParent,
	    'false' AS checked,
		m.SORT AS sort
	FROM
		r_menu m,
		r_role_menu rm
	WHERE
		m.SYSTEMID = #{systemid}
	  AND m.`STATUS` <![CDATA[<>]]> 'D'
	  AND m.ID = rm.MENUID
	  AND rm.ROLEID = #{roleid}
  ORDER BY m.SORT ASC
  </select>

  <select id="selectByUserAndSystemid" parameterType="java.util.HashMap" resultType="org.hanzhdy.manager.upc.vo.Resource">
SELECT
	m.ID AS id,
	m.MENUCODE AS code,
	m.MENUNAME AS name,
	m.PARENTID AS parentid,
	m.MENUICON AS icon,
	m.URLTYPE AS urltype,
	m.MENUURL AS url
FROM
	R_MENU m,
	R_ROLE r,
	R_ROLE_MENU rm,
	R_USER_ROLE ur
WHERE
	m.`STATUS` = 'N'
AND r.`STATUS` = 'N'
AND m.SHOWFLAG = 'SHOW'
AND m.SYSTEMID = #{systemid}
AND m.ID = rm.MENUID
AND r.ID = rm.ROLEID
AND r.ID = ur.ROLEID
AND ur.USERID=#{userid}
ORDER BY m.SORT
  </select>
</mapper>